.PHONY: help check-deps install-deps create-cluster delete-cluster build-image import-image deploy undeploy forward-port status clean all

# Variables
IMAGE_NAME := custom-nginx
IMAGE_TAG := latest
CLUSTER_NAME := lab
CLUSTER_SERVERS := 1
CLUSTER_AGENTS := 2
PORT := 8080
SERVICE_PORT := 80

# Couleurs pour l'affichage
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m # No Color

##@ Aide

help: ## Affiche ce message d'aide
	@echo "=========================================="
	@echo "ðŸ“š Makefile - Atelier Image to Cluster"
	@echo "=========================================="
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "Usage:\n  make \033[36m<target>\033[0m\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Installation et VÃ©rification

check-deps: ## VÃ©rifie que toutes les dÃ©pendances sont installÃ©es
	@echo "$(GREEN)ðŸ” VÃ©rification des dÃ©pendances...$(NC)"
	@bash scripts/check-deps.sh

install-deps: ## Installe les dÃ©pendances manquantes (Packer, K3d, Ansible)
	@echo "$(GREEN)ðŸ“¦ Installation des dÃ©pendances...$(NC)"
	@echo ""
	@echo "Installation de Packer..."
	@if ! command -v packer &> /dev/null; then \
		wget -q https://releases.hashicorp.com/packer/1.10.0/packer_1.10.0_linux_amd64.zip && \
		unzip -q packer_*.zip && \
		sudo mv packer /usr/local/bin/ && \
		rm packer_*.zip && \
		echo "âœ… Packer installÃ©"; \
	else \
		echo "âœ… Packer dÃ©jÃ  installÃ©"; \
	fi
	@echo ""
	@echo "Installation de K3d..."
	@if ! command -v k3d &> /dev/null; then \
		curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash && \
		echo "âœ… K3d installÃ©"; \
	else \
		echo "âœ… K3d dÃ©jÃ  installÃ©"; \
	fi
	@echo ""
	@echo "Installation d'Ansible..."
	@if ! command -v ansible &> /dev/null; then \
		pip install --quiet ansible && \
		echo "âœ… Ansible installÃ©"; \
	else \
		echo "âœ… Ansible dÃ©jÃ  installÃ©"; \
	fi
	@echo ""
	@echo "$(GREEN)âœ… Toutes les dÃ©pendances sont installÃ©es !$(NC)"

##@ Cluster Kubernetes

create-cluster: ## CrÃ©e le cluster K3d (1 master + 2 workers)
	@echo "$(GREEN)â˜¸ï¸  CrÃ©ation du cluster K3d...$(NC)"
	@if k3d cluster list | grep -q "$(CLUSTER_NAME)"; then \
		echo "$(YELLOW)âš ï¸  Le cluster $(CLUSTER_NAME) existe dÃ©jÃ $(NC)"; \
	else \
		k3d cluster create $(CLUSTER_NAME) \
			--servers $(CLUSTER_SERVERS) \
			--agents $(CLUSTER_AGENTS) \
			--port "$(PORT):30080@server:0" && \
		echo "" && \
		echo "$(GREEN)âœ… Cluster crÃ©Ã© avec succÃ¨s !$(NC)" && \
		echo "" && \
		kubectl get nodes; \
	fi

delete-cluster: ## Supprime le cluster K3d
	@echo "$(RED)ðŸ—‘ï¸  Suppression du cluster K3d...$(NC)"
	@k3d cluster delete $(CLUSTER_NAME) || true
	@echo "$(GREEN)âœ… Cluster supprimÃ©$(NC)"

##@ Build et Import de l'Image

build-image: ## Construit l'image Docker personnalisÃ©e avec Packer
	@echo "$(GREEN)ðŸ³ Build de l'image avec Packer...$(NC)"
	@cd packer && \
	packer init nginx.pkr.hcl && \
	packer build \
		-var "image_name=$(IMAGE_NAME)" \
		-var "image_tag=$(IMAGE_TAG)" \
		nginx.pkr.hcl
	@echo ""
	@echo "$(GREEN)âœ… Image construite avec succÃ¨s !$(NC)"
	@echo ""
	@docker images $(IMAGE_NAME)

import-image: ## Importe l'image dans le cluster K3d
	@echo "$(GREEN)ðŸ“¦ Import de l'image dans K3d...$(NC)"
	@bash scripts/import-image.sh $(IMAGE_NAME) $(IMAGE_TAG) $(CLUSTER_NAME)
	@echo "$(GREEN)âœ… Image importÃ©e$(NC)"

##@ DÃ©ploiement

deploy: ## DÃ©ploie l'application sur K3d avec Ansible
	@echo "$(GREEN)ðŸš€ DÃ©ploiement de l'application avec Ansible...$(NC)"
	@cd ansible && \
	ansible-playbook -i inventory.ini deploy.yml
	@echo ""
	@echo "$(GREEN)=========================================="
	@echo "âœ… DÃ©ploiement terminÃ© !"
	@echo "==========================================$(NC)"

undeploy: ## Supprime le dÃ©ploiement de l'application
	@echo "$(RED)ðŸ—‘ï¸  Suppression du dÃ©ploiement...$(NC)"
	@kubectl delete deployment custom-nginx --ignore-not-found=true
	@kubectl delete service custom-nginx --ignore-not-found=true
	@echo "$(GREEN)âœ… Application supprimÃ©e$(NC)"

##@ AccÃ¨s Ã  l'Application

forward-port: ## Forward le port pour accÃ©der Ã  l'application (Ctrl+C pour arrÃªter)
	@echo "$(GREEN)ðŸŒ Forwarding du port $(PORT) vers le service...$(NC)"
	@echo "$(YELLOW)ðŸ’¡ Dans GitHub Codespaces: Allez dans PORTS et rendez public le port $(PORT)$(NC)"
	@echo "$(YELLOW)Press Ctrl+C to stop$(NC)"
	@kubectl port-forward svc/custom-nginx $(PORT):$(SERVICE_PORT)

status: ## Affiche l'Ã©tat du cluster et de l'application
	@echo "$(GREEN)=========================================="
	@echo "ðŸ“Š Ã‰tat du Cluster et de l'Application"
	@echo "==========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)NÅ“uds du cluster:$(NC)"
	@kubectl get nodes
	@echo ""
	@echo "$(YELLOW)Pods:$(NC)"
	@kubectl get pods -l app=custom-nginx
	@echo ""
	@echo "$(YELLOW)Services:$(NC)"
	@kubectl get svc custom-nginx
	@echo ""
	@echo "$(YELLOW)Deployments:$(NC)"
	@kubectl get deployment custom-nginx
	@echo ""

##@ Nettoyage

clean: ## Nettoie tout (cluster + images Docker)
	@echo "$(RED)ðŸ§¹ Nettoyage complet...$(NC)"
	@make undeploy || true
	@make delete-cluster || true
	@docker rmi $(IMAGE_NAME):$(IMAGE_TAG) 2>/dev/null || true
	@echo "$(GREEN)âœ… Nettoyage terminÃ©$(NC)"

##@ Pipeline Complet

all: install-deps create-cluster build-image import-image deploy status ## Pipeline complet: installation â†’ crÃ©ation cluster â†’ build â†’ import â†’ deploy
	@echo ""
	@echo "$(GREEN)=========================================="
	@echo "ðŸŽ‰ Pipeline complet terminÃ© avec succÃ¨s !"
	@echo "==========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Pour accÃ©der Ã  l'application:$(NC)"
	@echo "1. ExÃ©cutez: make forward-port"
	@echo "2. Dans GitHub Codespaces, allez dans l'onglet PORTS"
	@echo "3. Rendez public le port $(PORT)"
	@echo "4. Cliquez sur l'URL pour accÃ©der Ã  l'application"
	@echo ""
