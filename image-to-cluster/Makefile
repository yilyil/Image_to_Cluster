.PHONY: help check-deps install-deps create-cluster delete-cluster build-image import-image deploy undeploy forward-port status clean all

# Variables
IMAGE_NAME := custom-nginx
IMAGE_TAG := latest
CLUSTER_NAME := lab
CLUSTER_SERVERS := 1
CLUSTER_AGENTS := 2
PORT := 8080
SERVICE_PORT := 80

# Couleurs
GREEN := \033[0;32m
YELLOW := \033[1;33m
RED := \033[0;31m
NC := \033[0m

##@ Aide

help: ## Affiche ce message d'aide
	@echo "=========================================="
	@echo "üìö Makefile - Atelier Image to Cluster"
	@echo "=========================================="
	@echo ""
	@awk 'BEGIN {FS = ":.*##"; printf "Usage:\n  make \033[36m<target>\033[0m\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

##@ Installation et V√©rification

check-deps: ## V√©rifie que toutes les d√©pendances sont install√©es
	@echo "$(GREEN)üîç V√©rification des d√©pendances...$(NC)"
	@bash scripts/check-deps.sh

install-deps: ## Installe les d√©pendances manquantes (Packer, K3d, Ansible)
	@echo "$(GREEN)üì¶ Installation des d√©pendances...$(NC)"
	@echo ""
	@echo "Installation de Packer..."
	@if ! command -v packer &> /dev/null; then \
		wget -q https://releases.hashicorp.com/packer/1.10.0/packer_1.10.0_linux_amd64.zip && \
		unzip -q packer_1.10.0_linux_amd64.zip -d /tmp/ && \
		sudo mv /tmp/packer /usr/local/bin/ && \
		rm -f packer_1.10.0_linux_amd64.zip && \
		echo "‚úÖ Packer install√©"; \
	else \
		echo "‚úÖ Packer d√©j√† install√©"; \
	fi
	@echo ""
	@echo "Installation de K3d..."
	@if ! command -v k3d &> /dev/null; then \
		curl -s https://raw.githubusercontent.com/k3d-io/k3d/main/install.sh | bash && \
		echo "‚úÖ K3d install√©"; \
	else \
		echo "‚úÖ K3d d√©j√† install√©"; \
	fi
	@echo ""
	@echo "Installation d'Ansible..."
	@if ! command -v ansible &> /dev/null; then \
		pip install --quiet ansible && \
		echo "‚úÖ Ansible install√©"; \
	else \
		echo "‚úÖ Ansible d√©j√† install√©"; \
	fi
	@echo ""
	@echo "$(GREEN)‚úÖ Toutes les d√©pendances sont install√©es !$(NC)"

##@ Cluster Kubernetes

create-cluster: ## Cr√©e le cluster K3d (1 master + 2 workers)
	@echo "$(GREEN)‚ò∏Ô∏è  Cr√©ation du cluster K3d...$(NC)"
	@if k3d cluster list 2>/dev/null | grep -q "$(CLUSTER_NAME)"; then \
		echo "$(YELLOW)‚ö†Ô∏è  Le cluster $(CLUSTER_NAME) existe d√©j√†$(NC)"; \
	else \
		k3d cluster create $(CLUSTER_NAME) \
			--servers $(CLUSTER_SERVERS) \
			--agents $(CLUSTER_AGENTS) \
			--port "$(PORT):30080@server:0" && \
		echo "" && \
		echo "$(GREEN)‚úÖ Cluster cr√©√© avec succ√®s !$(NC)" && \
		echo "" && \
		kubectl get nodes; \
	fi

delete-cluster: ## Supprime le cluster K3d
	@echo "$(RED)üóëÔ∏è  Suppression du cluster K3d...$(NC)"
	@k3d cluster delete $(CLUSTER_NAME) 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Cluster supprim√©$(NC)"

##@ Build et Import de l'Image

build-image: ## Construit l'image Docker personnalis√©e avec Packer ou Docker
	@echo "$(GREEN)üê≥ Build de l'image...$(NC)"
	@if command -v packer &> /dev/null; then \
		cd packer && \
		(packer init nginx.pkr.hcl 2>/dev/null || true) && \
		packer build -var "image_name=$(IMAGE_NAME)" -var "image_tag=$(IMAGE_TAG)" nginx.pkr.hcl 2>/dev/null || \
		(echo "$(YELLOW)‚ö†Ô∏è Packer a √©chou√©, utilisation de Docker...$(NC)" && \
		 cd .. && \
		 docker build -t $(IMAGE_NAME):$(IMAGE_TAG) -f - . << 'DOCKERFILE' \
FROM nginx:alpine\
COPY index.html /usr/share/nginx/html/index.html\
EXPOSE 80\
CMD ["nginx", "-g", "daemon off;"]\
DOCKERFILE\
		); \
	else \
		docker build -t $(IMAGE_NAME):$(IMAGE_TAG) -f - . << 'DOCKERFILE' \
FROM nginx:alpine\
COPY index.html /usr/share/nginx/html/index.html\
EXPOSE 80\
CMD ["nginx", "-g", "daemon off;"]\
DOCKERFILE\
	fi
	@echo ""
	@echo "$(GREEN)‚úÖ Image construite avec succ√®s !$(NC)"
	@echo ""
	@docker images $(IMAGE_NAME)

import-image: ## Importe l'image dans le cluster K3d
	@echo "$(GREEN)üì¶ Import de l'image dans K3d...$(NC)"
	@bash scripts/import-image.sh $(IMAGE_NAME) $(IMAGE_TAG) $(CLUSTER_NAME)
	@echo "$(GREEN)‚úÖ Image import√©e$(NC)"

##@ D√©ploiement

deploy: ## D√©ploie l'application sur K3d avec Ansible
	@echo "$(GREEN)üöÄ D√©ploiement de l'application avec Ansible...$(NC)"
	@cd ansible && ansible-playbook -i inventory.ini deploy.yml
	@echo ""
	@echo "$(GREEN)=========================================="
	@echo "‚úÖ D√©ploiement termin√© !"
	@echo "==========================================$(NC)"

undeploy: ## Supprime le d√©ploiement de l'application
	@echo "$(RED)üóëÔ∏è  Suppression du d√©ploiement...$(NC)"
	@kubectl delete deployment custom-nginx --ignore-not-found=true
	@kubectl delete service custom-nginx --ignore-not-found=true
	@echo "$(GREEN)‚úÖ Application supprim√©e$(NC)"

##@ Acc√®s √† l'Application

forward-port: ## Forward le port pour acc√©der √† l'application
	@echo "$(GREEN)üåê Forwarding du port $(PORT) vers le service...$(NC)"
	@echo "$(YELLOW)üí° Dans GitHub Codespaces: Allez dans PORTS et rendez public le port $(PORT)$(NC)"
	@echo "$(YELLOW)Press Ctrl+C to stop$(NC)"
	@kubectl port-forward svc/custom-nginx $(PORT):$(SERVICE_PORT)

status: ## Affiche l'√©tat du cluster et de l'application
	@echo "$(GREEN)=========================================="
	@echo "üìä √âtat du Cluster et de l'Application"
	@echo "==========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)N≈ìuds du cluster:$(NC)"
	@kubectl get nodes
	@echo ""
	@echo "$(YELLOW)Pods:$(NC)"
	@kubectl get pods -l app=custom-nginx
	@echo ""
	@echo "$(YELLOW)Services:$(NC)"
	@kubectl get svc custom-nginx
	@echo ""
	@echo "$(YELLOW)Deployments:$(NC)"
	@kubectl get deployment custom-nginx
	@echo ""

##@ Nettoyage

clean: ## Nettoie tout (cluster + images Docker)
	@echo "$(RED)üßπ Nettoyage complet...$(NC)"
	@make undeploy 2>/dev/null || true
	@make delete-cluster 2>/dev/null || true
	@docker rmi $(IMAGE_NAME):$(IMAGE_TAG) 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Nettoyage termin√©$(NC)"

##@ Pipeline Complet

all: install-deps create-cluster build-image import-image deploy status ## Pipeline complet automatique
	@echo ""
	@echo "$(GREEN)=========================================="
	@echo "üéâ Pipeline complet termin√© avec succ√®s !"
	@echo "==========================================$(NC)"
	@echo ""
	@echo "$(YELLOW)Pour acc√©der √† l'application:$(NC)"
	@echo "1. Ex√©cutez: make forward-port"
	@echo "2. Dans GitHub Codespaces, allez dans PORTS"
	@echo "3. Rendez public le port $(PORT)"
	@echo "4. Cliquez sur l'URL"
	@echo ""
